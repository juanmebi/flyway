pipeline {
  agent any 
  environment {
    DB_PROTEOMES=credentials('db-proteomes')
    FLYWAY_LOCATIONS="filesystem:$WORKSPACE/$params.ENVIRONMENT"
    FLYWAY_URL='jdbc:postgresql://localhost:5432/postgres'
    FLYWAY_PATH='/usr/local/bin/flyway-9.0.1'
  }
  stages {
    stage('Setup parameters') {
            steps {
                script { 
                    properties([
                        parameters([
                            string(
                                defaultValue: 'V1.', 
                                name: 'VERSION', 
                                trim: true
                            )
                        ])
                    ])
                }
            }
        }
    stage('Build - DB Changes') {
              steps {
                  flywayrunner  installationName: 'flyway',
                                flywayCommand: 'migrate',
                                credentialsId: 'db-proteomes',
                                url: "${FLYWAY_URL}",
                                locations: "${FLYWAY_LOCATIONS}/${params.ENVIRONMENT}",
                                commandLineArgs: ''
              }
    }
    stage('Validate - Changes') {
              steps {
                  flywayrunner  installationName: 'flyway',
                                flywayCommand: 'validate',
                                credentialsId: 'db-proteomes',
                                url: "${FLYWAY_URL}",
                                locations: "${FLYWAY_LOCATIONS}",
                                commandLineArgs: ''
              }
    }
    stage('Show Info') {
              steps {
                  flywayrunner  installationName: 'flyway',
                                flywayCommand: 'info',
                                credentialsId: 'db-proteomes',
                                url: "${FLYWAY_URL}",
                                locations: "${FLYWAY_LOCATIONS}",
                                commandLineArgs: ''
              }
    }
  }
}
